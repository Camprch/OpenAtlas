name: Daily Build & Deploy (GitHub Pages)

on:
  schedule:
    - cron: '0 5 * * *' # 05:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      DB_URL: ${{ secrets.DB_URL }}
      SOURCES_TELEGRAM: ${{ secrets.SOURCES_TELEGRAM }}
      MAX_MESSAGES_PER_CHANNEL: ${{ secrets.MAX_MESSAGES_PER_CHANNEL }}
      BATCH_SIZE: ${{ secrets.BATCH_SIZE }}
      TARGET_LANGUAGE: ${{ secrets.TARGET_LANGUAGE }}
      FETCH_WINDOW_HOURS: ${{ secrets.FETCH_WINDOW_HOURS }}
      AUTO_DELETE_DAYS: ${{ secrets.AUTO_DELETE_DAYS }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.3'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pipeline
        run: python tools/run_pipeline.py

      - name: Build static site
        run: python tools/build_static_site.py

      - name: Archive JSON exports
        run: |
          python - <<'PY'
          import os
          import shutil
          from pathlib import Path
          from datetime import datetime, timedelta, timezone

          days_raw = os.environ.get("AUTO_DELETE_DAYS", "0")
          try:
            days = int(days_raw)
          except ValueError:
            days = 0

          root = Path("static_site")
          data = root / "static" / "data"
          if not data.exists():
            raise SystemExit("Missing static data directory")

          archive_root = root / "archives"
          archive_root.mkdir(parents=True, exist_ok=True)

          stamp = datetime.now(timezone.utc).strftime("%Y-%m-%d")
          dest = archive_root / stamp
          dest.mkdir(parents=True, exist_ok=True)

          for name in ("events.json", "countries.json"):
            src = data / name
            if src.exists():
              shutil.copy2(src, dest / name)

          if days > 0:
            cutoff = datetime.now(timezone.utc) - timedelta(days=days)
            for p in archive_root.iterdir():
              if not p.is_dir():
                continue
              try:
                dt = datetime.strptime(p.name, "%Y-%m-%d").replace(tzinfo=timezone.utc)
              except ValueError:
                continue
              if dt < cutoff:
                shutil.rmtree(p, ignore_errors=True)
          PY

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: static_site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
